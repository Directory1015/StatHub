<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StatHub — Home</title>
  <meta name="description" content="StatHub — tap a league circle to view and share current player leaders." />
  <link rel="icon" type="image/svg+xml" href="assets/stathub-logo-crest.svg" />
  <style>
    :root{
      --bg:#0b0d12; --panel:#111724; --panel2:#0f1522;
      --tx:#e8edf7; --tx-dim:#a6b0c3; --divider:#27324a;
      --maxw:1200px; --brand:#5aa2ff;
      --shadow:0 8px 26px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      --accent:#00d2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1400px 700px at 50% -12%, rgba(90,162,255,.18), transparent 70%),
        radial-gradient(1000px 620px at 88% 8%, rgba(0,210,255,.12), transparent 65%),
        var(--bg);
      color:var(--tx);
    }

    header{
      display:flex; align-items:center; justify-content:center; gap:12px;
      padding:24px 14px 6px; flex-wrap:wrap;
    }
    .brand{display:inline-flex; align-items:center; gap:10px; background:#0e1422; border:1px solid var(--divider);
      padding:6px 10px; border-radius:999px; box-shadow:var(--shadow)}
    .brand img{width:26px; height:26px; display:block}
    .brand span{font-weight:900; letter-spacing:.3px; font-size:14px; color:#cfe2ff}

    h1{margin:6px 0 4px; font-size:clamp(30px,5vw,42px); text-shadow:0 0 14px rgba(90,162,255,.4)}
    .tag{color:var(--tx-dim); font-size:14px; width:100%; text-align:center; margin:0 0 8px}

    /* Toolbar with dropdown */
    .toolbar{display:flex; gap:10px; justify-content:center; padding:0 14px 6px; flex-wrap:wrap}
    .ddBtn{
      display:inline-flex; align-items:center; gap:8px;
      background:#121a2a; border:1px solid var(--divider); color:var(--tx);
      padding:8px 12px; border-radius:999px; font-weight:800; font-size:13px; cursor:pointer;
    }
    .ddBtn:hover{border-color:#3a4766; background:#182034}
    .ddWrap{position:relative}
    .ddPanel{
      position:absolute; left:50%; transform:translateX(-50%);
      margin-top:8px; width:min(780px, 96vw); z-index:60; display:none;
      background:linear-gradient(180deg,#111724,#0f1522);
      border:1px solid var(--divider); border-radius:14px; box-shadow:0 18px 40px rgba(0,0,0,.55);
      padding:12px;
    }
    .ddPanel.open{display:block}
    .ddGrid{display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));}
    .ddSec{background:#101729; border:1px solid var(--divider); border-radius:12px; padding:10px}
    .ddSec h4{margin:0 0 8px; font-size:13px; color:#cfe2ff; letter-spacing:.3px}
    .ddList{list-style:none; margin:0; padding:0; display:grid; gap:6px}
    .ddItem{
      display:flex; align-items:center; gap:8px; width:100%;
      background:#0f1522; border:1px solid var(--divider); border-radius:10px; padding:6px 8px;
      cursor:pointer; font-weight:800; color:#e8edf7; text-align:left;
    }
    .ddItem:hover{border-color:#33405b; background:#182034}
    .flag{font-size:16px; width:20px; text-align:center}
    .note{color:#a6b0c3; font-weight:700; font-size:11.5px; margin-left:auto; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:44%}

    .shell{max-width:var(--maxw); margin:0 auto; padding:12px 20px 40px}
    .grid{
      display:grid; gap:26px;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      justify-content:center; justify-items:center; align-items:start;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
    @media (max-width: 640px){ .grid{ grid-template-columns:repeat(2,minmax(0,1fr)); } }

    /* circle tiles */
    .tile{
      --accent:#5aa2ff;
      width:140px; height:140px; border-radius:50%;
      background:linear-gradient(180deg,#111724,#0f1522);
      border:2px solid var(--divider);
      box-shadow:var(--shadow);
      display:flex; align-items:center; justify-content:center; flex-direction:column;
      cursor:pointer; transition:.2s; position:relative; color:inherit;
      touch-action:manipulation;
    }
    @media (prefers-reduced-motion:reduce){ .tile{transition:none} }
    .tile:hover{
      transform: translateY(-6px) scale(1.05);
      border-color:var(--accent);
      box-shadow:0 14px 30px rgba(0,0,0,.45), 0 0 16px color-mix(in oklab, var(--accent) 45%, transparent);
    }

    .logoBox{
      width:70px; height:70px; margin-bottom:8px; display:grid; place-items:center; border-radius:50%;
      background:#0e1422; border:1px solid var(--divider); box-shadow:inset 0 0 18px rgba(90,162,255,.15);
      overflow:hidden;
    }
    .logoImg{ max-width:64px; max-height:64px; width:auto; height:auto; object-fit:contain; display:block; filter:drop-shadow(0 2px 4px rgba(0,0,0,.45)) }
    .logoEmoji{ font-size:40px; line-height:1; display:none }
    .tileName{ font-weight:900; font-size:14px; text-align:center }

    .tile[data-key="epl"]{--accent:#5c2d91}
    .tile[data-key="laliga"]{--accent:#ea1d2c}
    .tile[data-key="seriea"]{--accent:#0e5adf}
    .tile[data-key="bundesliga"]{--accent:#d0021b}
    .tile[data-key="ligue1"]{--accent:#cedc00}
    .tile[data-key="ucl"]{--accent:#1b2d6b}

    /* modal */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.70); display:none; align-items:center; justify-content:center; z-index:200}
    .overlay.active{display:flex}
    .modal{ --accent:#5aa2ff; width:min(700px,92vw); max-height:90vh; overflow:auto;
      background:linear-gradient(180deg,#111724,#0f1522); border:1px solid var(--divider); border-radius:20px;
      box-shadow:0 24px 60px rgba(0,0,0,.6); animation:zoomIn .28s ease; position:relative }
    @keyframes zoomIn{from{opacity:0; transform:scale(.9)} to{opacity:1; transform:scale(1)}}
    .modal[data-key="epl"]{--accent:#5c2d91}.modal[data-key="laliga"]{--accent:#ea1d2c}.modal[data-key="seriea"]{--accent:#0e5adf}
    .modal[data-key="bundesliga"]{--accent:#d0021b}.modal[data-key="ligue1"]{--accent:#cedc00}.modal[data-key="ucl"]{--accent:#1b2d6b}
    .mHd{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:16px 18px; border-bottom:1px solid var(--divider);
      position:sticky; top:0; background:linear-gradient(180deg, rgba(255,255,255,.03), transparent); backdrop-filter:blur(6px); z-index:2}
    .mTitle{font-weight:900; font-size:18px; display:flex; align-items:center; gap:10px}
    .mDot{width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px color-mix(in oklab, var(--accent) 60%, transparent)}
    .mMeta{color:var(--tx-dim); font-size:12px; font-weight:700}
    .mClose{background:none; border:1px solid var(--divider); color:var(--tx); font-size:18px; border-radius:10px; padding:6px 10px; cursor:pointer}
    .mClose:hover{border-color:var(--accent)}
    .record{padding:12px 18px; border-bottom:1px dashed var(--divider); color:var(--tx-dim); font-size:13px; line-height:1.5}
    .record b{color:#ffd76a; text-shadow:0 0 10px rgba(255,215,106,.25)}
    .cols{display:grid; gap:18px; padding:16px 18px 6px}
    .col h4{margin:0 0 8px; font-size:14px; letter-spacing:.2px; color:var(--tx); position:relative; padding-left:10px}
    .col h4::before{content:""; position:absolute; left:0; top:50%; transform:translateY(-50%); width:4px; height:14px; border-radius:2px;
      background:var(--accent); box-shadow:0 0 10px color-mix(in oklab, var(--accent) 60%, transparent)}
    .list{list-style:none; margin:0; padding:0; display:grid; gap:8px}
    .row{display:grid; grid-template-columns:26px 1fr auto; gap:10px; align-items:center; padding:8px 10px; border:1px solid var(--divider);
      border-radius:12px; background:#121a2a}
    .row:hover{border-color:#33405b; background:#182034}
    .idx{width:24px; height:24px; border-radius:50%; display:grid; place-items:center; font-weight:900; color:#aeb7cc;
      background:rgba(255,255,255,.05); border:1px solid var(--divider)}
    .nm{font-weight:800; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .val{font-weight:900; font-size:13px; color:#cfe2ff; padding:2px 10px; border-radius:999px; border:1px solid var(--divider);
      background:#0f1522; min-width:34px; text-align:center}
    .row:first-child .idx{background:linear-gradient(180deg,#2a2230,#3a2a12); border-color:#6b5320; color:#ffd76a}
    .row:first-child .nm::before{content:"👑 "}

    .shareBar{display:flex; gap:10px; flex-wrap:wrap; padding:12px 18px 16px; border-top:1px solid var(--divider)}
    .btn{display:inline-flex; align-items:center; gap:8px; background:#121a2a; border:1px solid var(--divider); color:#fff;
      padding:8px 10px; border-radius:10px; font-weight:700; font-size:13px; cursor:pointer; touch-action:manipulation}
    .btn:hover{border-color:var(--brand)}
    .shareLinks{display:flex; gap:10px; padding:0 18px 18px}
    .shareLinks a{font-size:13px; color:#cfe2ff; text-decoration:none; border:1px solid var(--divider); padding:6px 8px; border-radius:8px}
    .shareLinks a:hover{border-color:var(--brand)}

    footer{text-align:center; color:#a6b0c3; padding:20px; font-size:12px; border-top:1px solid rgba(255,255,255,.05)}

    /* export card (for jpeg capture) */
    .shareCard{
      position:relative;
      width:1080px; padding:36px 36px 28px; border-radius:24px;
      background: radial-gradient(1200px 600px at 50% -10%, rgba(90,162,255,.18), transparent 60%), #0b0d12;
      color:#e8edf7; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; border:2px solid #27324a;
    }
    .shareCard .top{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px}
    .shareCard .league{display:flex; align-items:center; gap:14px; font-weight:900; font-size:40px}
    .shareCard .logo{width:72px; height:72px; border-radius:14px; overflow:hidden; display:grid; place-items:center;
      background:#0e1422; border:1px solid #27324a}
    .shareCard .logo img{max-width:68px; max-height:68px}
    .shareCard .date{color:#a6b0c3; font-weight:700}
    .shareCard .rec{margin:8px 0 18px; color:#a6b0c3; font-size:24px}
    .shareCard .rec b{color:#ffd76a}
    .shareCard .cols{display:grid; gap:18px; grid-template-columns:1fr 1fr}
    .shareCard h3{margin:0 0 10px; font-size:26px; color:#cfe2ff}
    .shareCard ol{list-style:none; margin:0; padding:0; display:grid; gap:10px}
    .shareCard li{display:grid; grid-template-columns:40px 1fr 60px; gap:12px; align-items:center; background:#121a2a; border:1px solid #27324a; border-radius:12px; padding:10px 12px}
    .shareCard .i{width:34px; height:34px; display:grid; place-items:center; border-radius:50%; background:#0f1522; color:#a6b0c3; font-weight:900}
    .shareCard .name{font-weight:800; font-size:22px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .shareCard .v{font-weight:900; font-size:22px; color:#cfe2ff; text-align:center}
    .wm{position:absolute; right:24px; bottom:24px; width:72px; height:auto; opacity:.9; filter: drop-shadow(0 2px 6px rgba(0,0,0,.5));}

    /* Placeholder helper */
    .noData{
      margin:8px 18px 0; padding:10px 12px; border:1px dashed var(--divider); border-radius:12px; background:#101729; color:#cfe2ff; font-size:12.5px
    }
    .noData code{white-space:pre-wrap; display:block; background:#0f1522; border:1px solid #27324a; padding:8px; border-radius:8px; color:#e8edf7}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>
<body>
  <header>
    <span class="brand">
      <img src="assets/stathub-logo-crest.svg" alt="StatHub logo">
      <span>StatHub</span>
    </span>
    <h1>StatHub</h1>
    <p class="tag">Tap a league circle or choose from the dropdown to view current <b>player</b> leaders.</p>

    <!-- Dropdown -->
    <div class="toolbar">
      <div class="ddWrap">
        <button class="ddBtn" id="moreBtn" aria-haspopup="true" aria-expanded="false">More Leagues & Tournaments ▾</button>
        <div class="ddPanel" id="morePanel" role="menu" aria-label="More Leagues & Tournaments">
          <div class="ddGrid">
            <section class="ddSec">
              <h4>Domestic Leagues</h4>
              <ul class="ddList" id="ddDomestic"></ul>
            </section>
            <section class="ddSec">
              <h4>International & Cups</h4>
              <ul class="ddList" id="ddCups"></ul>
            </section>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="shell">
    <div id="tiles" class="grid" aria-live="polite"></div>
  </main>

  <!-- Modal -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="modal" class="modal">
      <div class="mHd">
        <div class="mTitle"><span class="mDot"></span><span id="mLeague">League</span></div>
        <div class="mMeta" id="mDate"></div>
        <button class="mClose" id="mClose" aria-label="Close">×</button>
      </div>
      <div class="record" id="mRecord"></div>
      <div id="noDataBox" class="noData" style="display:none"></div>

      <div class="cols">
        <section class="col">
          <h4>Current Top Scorers</h4>
          <ol class="list" id="mScorers"></ol>
        </section>
        <section class="col">
          <h4>Current Top Assisters</h4>
          <ol class="list" id="mAssisters"></ol>
        </section>
      </div>

      <div class="shareBar">
        <button class="btn" id="btnSave"><span>📷</span> Save JPG</button>
        <button class="btn" id="btnShare"><span>📤</span> Share</button>
        <button class="btn" id="btnOpen"><span>🖼️</span> Open JPG</button>
        <button class="btn" id="btnCopyLink"><span>🔗</span> Copy Link</button>
        <span id="shareStatus" style="color:#a6f3c3; font-size:12px; font-weight:700"></span>
      </div>
      <div class="shareLinks">
        <a id="linkX" target="_blank" rel="noopener">Share on X</a>
        <a id="linkFB" target="_blank" rel="noopener">Facebook</a>
        <a id="linkWA" target="_blank" rel="noopener">WhatsApp</a>
        <a id="linkTG" target="_blank" rel="noopener">Telegram</a>
      </div>
    </div>
  </div>

  <!-- Fallback JSON (if leaders.json fails) -->
  <script type="application/json" id="leaders-fallback">
  {"updated":"2025-09-28","competitions":[
    {"key":"epl","name":"Premier League","record":{"holder":"Erling Haaland","goals":"36","season":"2022/23"},
      "scorers":[{"name":"Erling Haaland (Man City)","value":"8"},{"name":"Antoine Semenyo (Bournemouth)","value":"4"},{"name":"Jaidon Anthony (Burnley)","value":"4"}],
      "assisters":[{"name":"Jack Grealish (Everton)","value":"4"},{"name":"Mohammed Kudus (Tottenham Hotspur)","value":"4"},{"name":"El Hadji Malick Diouf (West Ham United)","value":"3"}]},
    {"key":"laliga","name":"La Liga","record":{"holder":"Lionel Messi","goals":"50","season":"2011/12"},
      "scorers":[{"name":"Kylian Mbappé (Real Madrid)","value":"8"},{"name":"Julián Álvarez (Atl. Madrid)","value":"6"},{"name":"Etta Eyong (Levante)","value":"4"}],
      "assisters":[{"name":"Vinícius Júnior (Real Madrid)","value":"4"},{"name":"Luis Milla (Getafe)","value":"4"},{"name":"Lamine Yamal (Barcelona)","value":"3"}]},
    {"key":"seriea","name":"Serie A","record":{"holder":"Ciro Immobile","goals":"36","season":"2019/20"},
      "scorers":[{"name":"Christian Pulisic (AC Milan)","value":"4"},{"name":"Nico Paz (Como)","value":"3"},{"name":"Marcus Thuram (Inter)","value":"3"}],
      "assisters":[{"name":"Kenan Yıldız (Juventus Turin)","value":"3"},{"name":"Nico Paz (Como 1907)","value":"3"},{"name":"Nikola Krstović (Atalanta Bergamo)","value":"3"}]},
    {"key":"bundesliga","name":"Bundesliga","record":{"holder":"Robert Lewandowski","goals":"41","season":"2020/21"},
      "scorers":[{"name":"Harry Kane (Bayern Munich)","value":"10"},{"name":"Can Uzun (Eintracht Frankfurt)","value":"5"},{"name":"Fisnik Asllani (Hoffenheim)","value":"4"}],
      "assisters":[{"name":"Andrej Ilic (1. FC Union Berlin)","value":"4"},{"name":"Samuel Mbangula (SV Werder Bremen)","value":"3"},{"name":"Ritsu Doan (Eintracht Frankfurt)","value":"3"}]},
    {"key":"ligue1","name":"Ligue 1","record":{"holder":"Kylian Mbappé","goals":"27","season":"2018/19"},
      "scorers":[{"name":"Ansu Fati (Monaco)","value":"3"},{"name":"Pierre-Emerick Aubameyang (Marseille)","value":"3"},{"name":"Bradley Barcola (PSG)","value":"3"}],
      "assisters":[{"name":"Ludovic Ajorque (Stade Brest 29)","value":"4"},{"name":"Dilane Bakwa (RC Strasbourg Alsace)","value":"3"},{"name":"Félix Correia (LOSC Lille)","value":"3"}]},
    {"key":"ucl","name":"UEFA Champions League","record":{"holder":"Cristiano Ronaldo","goals":"17","season":"2013/14"},
      "scorers":[{"name":"Kylian Mbappé (Real Madrid)","value":"5"},{"name":"Francisco Trincão (Sporting CP)","value":"2"},{"name":"Marcos Llorente (Atlético Madrid)","value":"2"}],
      "assisters":[{"name":"Lukáš Provod (Slavia Praha)","value":"2"},{"name":"Hakan Çalhanoğlu (Inter Milan)","value":"2"},{"name":"Lamine Yamal (Barcelona)","value":"1"}]}
  ]}
  </script>

  <script>
    const $ = (s, r=document)=>r.querySelector(s);
    const BRAND = 'StatHub';

    /* Logos for the main tiles */
    const LOGOS = {
      epl:        { src: 'assets/epl.png',        fallback: '🇬🇧', alt: 'Premier League logo' },
      laliga:     { src: 'assets/laliga.png',     fallback: '🇪🇸', alt: 'La Liga logo' },
      seriea:     { src: 'assets/seriea.png',     fallback: '🇮🇹', alt: 'Serie A logo' },
      bundesliga: { src: 'assets/bundesliga.png', fallback: '🇩🇪', alt: 'Bundesliga logo' },
      ligue1:     { src: 'assets/ligue1.png',     fallback: '🇫🇷', alt: 'Ligue 1 logo' },
      ucl:        { src: 'assets/ucl.png',        fallback: '⭐',   alt: 'UEFA Champions League logo' }
    };

    /* ===== Dropdown data ===== */
    const DOMESTIC = [
      {key:'mls',          name:'Major League Soccer',         flag:'🇺🇸'},
      {key:'eredivisie',   name:'Eredivisie',                  flag:'🇳🇱'},
      {key:'primeiraliga', name:'Primeira Liga',               flag:'🇵🇹'},
      {key:'saudi',        name:'Saudi Pro League',            flag:'🇸🇦'},
      {key:'brasileirao',  name:'Brasileirão Série A',         flag:'🇧🇷'},
      {key:'argprimera',   name:'Argentine Primera División',  flag:'🇦🇷'},
      {key:'ligamx',       name:'Liga MX',                     flag:'🇲🇽'},
      {key:'j1',           name:'J1 League',                   flag:'🇯🇵'},
      {key:'rpl',          name:'Russian Premier League',      flag:'🇷🇺'},
      {key:'superlig',     name:'Turkish Süper Lig',           flag:'🇹🇷'},
      {key:'jpl',          name:'Belgian Pro League',          flag:'🇧🇪'},
      {key:'scottish',     name:'Scottish Premiership',        flag:'🏴'},
      {key:'upl',          name:'Ukrainian Premier League',    flag:'🇺🇦'},
      {key:'efl',          name:'EFL Championship',            flag:'🏴'}
    ];

    const CUPS = [
      {key:'ucl',           name:'UEFA Champions League',         flag:'⭐', note:'Matchday 1: Sep 16–18, 2025'},
      {key:'uel',           name:'UEFA Europa League',            flag:'🏟️', note:'Ongoing league phase'},
      {key:'uecl',          name:'UEFA Conference League',        flag:'🏟️', note:'Ongoing league phase'},
      {key:'conmebol_wcq',  name:'CONMEBOL World Cup Qualifiers', flag:'🌎', note:'Ongoing; concludes Sep 2025'},
      {key:'afc_wcq',       name:'AFC World Cup Qualifiers',      flag:'🌏', note:'Ongoing'},
      {key:'caf_wcq',       name:'CAF World Cup Qualifiers',      flag:'🌍', note:'Ongoing'},
      {key:'uefa_wcq',      name:'UEFA European Qualifiers',      flag:'🇪🇺', note:'MD 5–6: Sep 4–9, 2025'},
      {key:'nations',       name:'UEFA Nations League',           flag:'🇪🇺', note:'Ongoing group stages'}
    ];

    /* Lookup for names/notes when a key isn't in leaders.json yet */
    const KEY_INFO = {};
    [...DOMESTIC, ...CUPS].forEach(x => KEY_INFO[x.key] = x);

    async function getData(){
      try{
        const res = await fetch('leaders.json?v='+Date.now(), {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const j = await res.json();
        if(!j || !Array.isArray(j.competitions)) throw new Error('Malformed JSON');
        return j;
      }catch(e){
        const fallback = $('#leaders-fallback');
        return JSON.parse(fallback.textContent);
      }
    }

    /* ===== Dropdown render and behavior ===== */
    function renderDropdown(){
      const makeItem = ({key, name, flag, note}) => `
        <button class="ddItem" data-key="${key}" role="menuitem">
          <span class="flag">${flag||'🏆'}</span>
          <span class="nm">${name}</span>
          ${note?`<span class="note">${note}</span>`:''}
        </button>`;
      $('#ddDomestic').innerHTML = DOMESTIC.map(makeItem).join('');
      $('#ddCups').innerHTML     = CUPS.map(makeItem).join('');

      const panel = $('#morePanel');
      const btn = $('#moreBtn');
      const toggle = (open) => {
        panel.classList.toggle('open', open);
        btn.setAttribute('aria-expanded', String(open));
      };

      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        toggle(!panel.classList.contains('open'));
      });
      document.addEventListener('click', (e)=>{
        if (!panel.contains(e.target) && e.target !== btn) toggle(false);
      });
    }

    function hookDropdownClicks(DATA){
      $('#morePanel').addEventListener('click', (e)=>{
        const el = e.target.closest('.ddItem');
        if (!el) return;
        const key = el.getAttribute('data-key');
        openByKey(key, DATA);
        // close panel
        $('#morePanel').classList.remove('open');
        $('#moreBtn').setAttribute('aria-expanded','false');
      });
    }

    /* ===== Main tiles ===== */
    function renderTiles(DATA){
      const wrap = $('#tiles');
      const bust = Date.now();
      wrap.innerHTML = DATA.competitions.map(c => {
        const logo = LOGOS[c.key] || { src:'', fallback:'🏆', alt:`${c.name} logo` };
        return `
          <button class="tile" data-key="${c.key}" aria-label="${c.name}" title="${c.name}">
            <div class="logoBox">
              <img class="logoImg" loading="lazy" decoding="async" src="${logo.src}?v=${bust}" alt="${logo.alt}">
              <span class="logoEmoji" aria-hidden="true">${logo.fallback}</span>
            </div>
            <div class="tileName">${c.name}</div>
          </button>
        `;
      }).join('');

      wrap.querySelectorAll('.tile').forEach(btn=>{
        const key = btn.getAttribute('data-key');
        const img = btn.querySelector('.logoImg');
        const emoji = btn.querySelector('.logoEmoji');
        img.addEventListener('error', ()=>{ img.style.display='none'; emoji.style.display='block'; });
        btn.addEventListener('click', ()=>{
          openByKey(key, DATA);
          const league = DATA.competitions.find(x=>x.key===key) || KEY_INFO[key];
          if (league) updateShareLinks(key, league.name || league?.name);
          history.replaceState(null, '', withLeagueParam(key));
        });
      });

      // Deep link support (?league=key)
      const urlKey = new URLSearchParams(location.search).get('league');
      if (urlKey) {
        openByKey(urlKey, DATA);
        const info = DATA.competitions.find(x=>x.key===urlKey) || KEY_INFO[urlKey];
        if (info) updateShareLinks(urlKey, info.name || info?.name);
      }
    }

    function listHTML(arr){
      return arr.map((p,i)=>`
        <li class="row">
          <span class="idx">${i+1}</span>
          <span class="nm">${p.name}</span>
          <span class="val">${p.value}</span>
        </li>
      `).join('');
    }

    function withLeagueParam(key){
      const u = new URL(location.href);
      u.searchParams.set('league', key);
      return u.toString();
    }

    function openByKey(key, DATA){
      const league = DATA.competitions.find(x=>x.key===key);
      if (league) {
        openModal(league, DATA.updated, /*placeholder*/false);
      } else {
        const info = KEY_INFO[key] || {name:key.toUpperCase(), flag:'🏆'};
        const placeholder = {
          key,
          name: info.name,
          record: { holder:'—', goals:'—', season:'—' },
          scorers: [],
          assisters: []
        };
        openModal(placeholder, DATA.updated, /*placeholder*/true, info.note);
      }
    }

    function openModal(league, updated, isPlaceholder=false, noteText=null){
      const overlay = $('#overlay'); const modal = $('#modal');
      modal.setAttribute('data-key', league.key);
      $('#mLeague').textContent = league.name || (KEY_INFO[league.key]?.name) || league.key.toUpperCase();
      $('#mDate').textContent = new Date(updated).toLocaleDateString();

      let rec = `All-time single-season record: ${league.record?.holder && league.record.holder!=='—'
                  ? `<b>${league.record.holder}</b> • ${league.record.goals} goals • ${league.record.season}`
                  : `<span class="muted">—</span>`}`;
      if (noteText) rec += `<div class="muted" style="margin-top:4px">${noteText}</div>`;
      $('#mRecord').innerHTML = rec;

      // Lists
      $('#mScorers').innerHTML   = listHTML(league.scorers || []);
      $('#mAssisters').innerHTML = listHTML(league.assisters || []);

      // No data helper
      const noData = $('#noDataBox');
      if (isPlaceholder || (!league.scorers?.length && !league.assisters?.length)) {
        const key = league.key;
        const template = {
          key,
          name: (KEY_INFO[key]?.name) || key.toUpperCase(),
          record: { holder: "—", goals: "—", season: "—" },
          scorers: [
            { "name": "Player A (Team)", "value": "0" },
            { "name": "Player B (Team)", "value": "0" },
            { "name": "Player C (Team)", "value": "0" }
          ],
          assisters: [
            { "name": "Player D (Team)", "value": "0" },
            { "name": "Player E (Team)", "value": "0" },
            { "name": "Player F (Team)", "value": "0" }
          ]
        };
        noData.style.display = 'block';
        noData.innerHTML = `
          <strong>No data yet for ${KEY_INFO[key]?.name || key.toUpperCase()}.</strong>
          <div>Add this block to <code>leaders.json</code>:</div>
          <code>${JSON.stringify(template, null, 2)}</code>
        `;
      } else {
        noData.style.display = 'none';
        noData.innerHTML = '';
      }

      // Share buttons
      const key = league.key;
      $('#btnSave').onclick  = ()=> exportShareCard(league, updated, 'download');
      $('#btnOpen').onclick  = ()=> exportShareCard(league, updated, 'open');
      $('#btnShare').onclick = ()=> exportShareCard(league, updated, 'share');
      $('#btnCopyLink').onclick = async ()=>{
        try{ await navigator.clipboard.writeText(withLeagueParam(key));
             $('#shareStatus').textContent='Link copied!'; setTimeout(()=>$('#shareStatus').textContent='',1600); }
        catch(e){ $('#shareStatus').textContent='Copy failed'; }
      };

      // Links
      updateShareLinks(key, league.name || (KEY_INFO[key]?.name) || key.toUpperCase());

      overlay.classList.add('active'); overlay.setAttribute('aria-hidden','false'); $('#mClose').focus();
    }

    function closeModal(){
      const overlay=$('#overlay');
      overlay.classList.remove('active');
      overlay.setAttribute('aria-hidden','true');
      const u = new URL(location.href); u.searchParams.delete('league'); history.replaceState(null,'',u);
    }

    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
    $('#overlay').addEventListener('click', (e)=>{ if(e.target.id==='overlay') closeModal(); });
    $('#mClose').addEventListener('click', closeModal);

    function updateShareLinks(key, name){
      const url = encodeURIComponent(withLeagueParam(key));
      const text = encodeURIComponent(`${name} player leaders on ${BRAND}`);
      $('#linkX').href  = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
      $('#linkFB').href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
      $('#linkWA').href = `https://api.whatsapp.com/send?text=${text}%20${url}`;
      $('#linkTG').href = `https://t.me/share/url?url=${url}&text=${text}`;
    }

    async function ensureHtml2Canvas(){
      if (window.html2canvas) return true;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
        s.onload=res; s.onerror=rej; document.head.appendChild(s);
      });
      return !!window.html2canvas;
    }

    /* === Image export (JPEG) with fallbacks === */
    async function exportShareCard(league, updated, mode){
      try{
        await ensureHtml2Canvas();

        // Build offscreen card
        const box=document.createElement('div');
        box.className='shareCard';
        const crest='assets/stathub-logo-crest.svg';
        const when=new Date(updated).toLocaleDateString();
        const makeList=arr=>(arr && arr.length?arr:[]).map((p,i)=>`
          <li><span class="i">${i+1}</span><span class="name">${p.name}</span><span class="v">${p.value}</span></li>
        `).join('');
        box.innerHTML=`
          <div class="top">
            <div class="league">
              <div class="logo"><img src="${crest}" alt="StatHub"></div>
              <span>${league.name || (KEY_INFO[league.key]?.name) || league.key.toUpperCase()}</span>
            </div>
            <div class="date">${when}</div>
          </div>
          <div class="rec">
            ${league.record?.holder && league.record.holder!=='—'
              ? `All-time single-season record: <b>${league.record.holder}</b> • ${league.record.goals} goals • ${league.record.season}`
              : `<span class="muted">No historical record on file</span>`}
          </div>
          <div class="cols">
            <div><h3>Top Scorers</h3><ol>${makeList(league.scorers)}</ol></div>
            <div><h3>Top Assisters</h3><ol>${makeList(league.assisters)}</ol></div>
          </div>
          <img class="wm" src="${crest}" alt="">
        `;
        box.style.position='fixed'; box.style.left='-20000px'; document.body.appendChild(box);

        const canvas=await html2canvas(box,{backgroundColor:'#0b0d12',scale:2,useCORS:true});
        box.remove();

        const blob=await new Promise(r=>canvas.toBlob(r,'image/jpeg',0.92));
        const fileName=`stathub-${league.key}-leaders.jpg`;

        if (mode==='download'){
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a'); a.href=url; a.download=fileName; a.click(); URL.revokeObjectURL(url);
          $('#shareStatus').textContent='Saved!'; setTimeout(()=>$('#shareStatus').textContent='',1600);
          return;
        }

        if (mode==='open'){
          const url=URL.createObjectURL(blob);
          window.open(url,'_blank'); // iPhone: Safari Share → Messages/WhatsApp/etc.
          setTimeout(()=>URL.revokeObjectURL(url), 5000);
          return;
        }

        // mode === 'share'
        const file = new File([blob], fileName, {type:'image/jpeg'});
        try{
          if (navigator.canShare && navigator.canShare({files:[file]})) {
            await navigator.share({title: BRAND, text:`${league.name || league.key.toUpperCase()} leaders`, files:[file]});
            return;
          }
        }catch(_){} // ignore quirks

        // Share deep link as reliable fallback
        if (navigator.share){
          await navigator.share({ title: BRAND, text:`${league.name || league.key.toUpperCase()} leaders`, url: withLeagueParam(league.key) });
          return;
        }

        // Clipboard or new tab
        try{
          await navigator.clipboard.write([new ClipboardItem({'image/jpeg': blob})]);
          $('#shareStatus').textContent='Image copied — paste to chats!';
          setTimeout(()=>$('#shareStatus').textContent='',2000);
        }catch(e){
          const url=URL.createObjectURL(blob);
          window.open(url,'_blank');
          setTimeout(()=>URL.revokeObjectURL(url),5000);
        }
      }catch(err){
        $('#shareStatus').textContent='Share failed';
        setTimeout(()=>$('#shareStatus').textContent='',2000);
        console.error(err);
      }
    }

    // Init
    (async function init(){
      renderDropdown();
      const DATA = await getData();
      renderTiles(DATA);
      hookDropdownClicks(DATA);
    })();
  </script>
</body>
</html>














